/* @preserve bluelinky / MIT License / https://github.com/Hacksore/bluelinky */
import e,{HTTPError as t,ParseError as i}from"got";import*as o from"winston";import{readFile as n}from"fs";import{promisify as r}from"util";import s,{URLSearchParams as a}from"url";import{CookieJar as d}from"tough-cookie";import{EventEmitter as l}from"events";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function c(e,t,i,o){return new(i||(i=Promise))((function(n,r){function s(e){try{d(o.next(e))}catch(e){r(e)}}function a(e){try{d(o.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}d((o=o.apply(e,t||[])).next())}))}const h=process.env.LOG_LEVEL||"info",{colorize:u,json:v,combine:p,timestamp:g,printf:f}=o.format,m=f((({level:e,message:t,timestamp:i})=>(["array","object"].includes(typeof t)&&(t=JSON.stringify(t,null,2)),`[${i}] ${e}: ${t}`))),y=p(g({format:"YYYY-MM-DD HH:mm:ss"}),u(),v(),m),b=o.createLogger({format:y,level:h,transports:[new o.transports.Console({})]}),C=e=>({login:`${e}/tods/api/lgn`,logout:`${e}/tods/api/lgout`,vehicleList:`${e}/tods/api/vhcllst`,vehicleInfo:`${e}/tods/api/sltvhcl`,status:`${e}/tods/api/lstvhclsts`,remoteStatus:`${e}/tods/api/rltmvhclsts`,lock:`${e}/tods/api/drlck`,unlock:`${e}/tods/api/drulck`,start:`${e}/tods/api/evc/rfon`,stop:`${e}/tods/api/evc/rfoff`,startCharge:`${e}/tods/api/evc/rcstrt`,stopCharge:`${e}/tods/api/evc/rcstp`,setChargeTarget:`${e}/tods/api/evc/setsoc`,locate:`${e}/tods/api/fndmcr`,hornlight:`${e}/tods/api/hornlight`,verifyAccountToken:`${e}/tods/api/vrfyacctkn`,verifyPin:`${e}/tods/api/vrfypin`,verifyToken:`${e}/tods/api/vrfytnc`}),w=e=>{const t=`https://${e}`;return{host:e,baseUrl:t,origin:"SPA",endpoints:Object.freeze(C(t))}},k=e=>{switch(e){case"hyundai":return Object.freeze(Object.assign({brand:"hyundai"},w("mybluelink.ca")));case"kia":return Object.freeze(Object.assign({brand:"hyundai"},w("kiaconnect.ca")));default:throw new Error(`Constructor ${e} is not managed.`)}},T=Buffer.from("IDbMgWBXgic4MAyMgf5PFFRAdGX5O3IyC3uvN3scCs0gDpTFDuyvBorlAH9JMM2/hys=","base64"),S=Buffer.from("V60WkEmyRQaAfrBF1623/7QL62MjLVbCHdItGzQ1g5T/hkmKmMVTaMHv4cKGzgD3kfc=","base64"),A=Buffer.from("wLTVxwidmH8CfJYBWSnHD6E0huk0ozdiuygB4hLkM5XCgzAL1Dk5sE36d/bx5PFMQeU=","base64"),$=Buffer.from("RFtoRq/vDXJmRndoZaZQyfOot7OrIqGVFj96iY2WL3yyH5Z/pUvlUhqmCxD2t+D65SQ=","base64");var O;!function(e){e.LOCAL="LOCAL",e.DISTANT="DISTANT"}(O||(O={}));const D=new Map,I=(t,i,o)=>()=>c(void 0,void 0,void 0,(function*(){var s;const{stamps:a,generated:d,frequency:l}=null!==(s=D.get(t))&&void 0!==s?s:yield((t,i,o=`${i}${t}.v2.json`)=>c(void 0,void 0,void 0,(function*(){if(o.startsWith("file://")){const[,e]=o.split("file://"),t=yield r(n)(e);return JSON.parse(t.toString("utf-8"))}const{body:i}=yield e(o,{json:!0});return D.set(t,i),i})))(t,i,o),h=new Date(d),u=Date.now()-h.getTime(),v=Math.floor(u/l);return v/(a.length-1)>=.9&&D.delete(t),a[Math.min(v,a.length-1)]})),L=(e,t,i)=>{const o=((e,t)=>{switch(t){case j.AU:return"kia"===e?T:S;case j.EU:return"kia"===e?A:$;default:throw new Error("Local stamp generation is only supported in Australia and Europe")}})(t,i);return()=>c(void 0,void 0,void 0,(function*(){const t=Buffer.from(`${e}:${Date.now()}`,"utf-8");return Promise.resolve(((e,t)=>{if(e.length!==t.length)throw new Error(`XOR Buffers are not the same size ${e.length} vs ${t.length}`);const i=Buffer.alloc(e.length);for(let o=0;o<i.length;o++)i.writeUInt8(e[o]^t[o],o);return i})(o,t).toString("base64"))}))},E=({appId:e,brand:t,mode:i,region:o,stampHost:n,stampsFile:r})=>{switch(i){case O.LOCAL:return L(e,t,o);case O.DISTANT:default:return I(`${t}-${e}`,n,r)}},M=["cs","da","nl","en","fi","fr","de","it","pl","hu","no","sk","es","sv"],P=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),R=({brand:e,stampMode:t=O.DISTANT,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.hyundai.com:8080",o=`https://${i}`,n="6d477c38-3ca4-4cf3-9557-2a1929a94654",r="1eba27d2-9a5b-4eba-8ec7-97eb6c62fb51";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(P(o,n)),basicToken:"Basic NmQ0NzdjMzgtM2NhNC00Y2YzLTk1NTctMmExOTI5YTk0NjU0OktVeTQ5WHhQekxwTHVvSzB4aEJDNzdXNlZYaG10UVI5aVFobUlGampvWTRJcHhzVg==",GCMSenderID:"414998006775",stamp:E({appId:r,brand:"hyundai",mode:e,region:j.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.hyundai.com/auth/realms/euhyundaiidm/protocol/openid-connect/auth?client_id=64621b96-0f0d-11ec-82a8-0242ac130003&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="prd.eu-ccapi.kia.com:8080",o=`https://${i}`,n="fdc85c00-0a2f-4c64-bcb4-2cfb1500730a",r="a2b8469b-30a3-4361-8e13-6fceea8fbe74";return{brand:"kia",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(P(o,n)),basicToken:"Basic ZmRjODVjMDAtMGEyZi00YzY0LWJjYjQtMmNmYjE1MDA3MzBhOnNlY3JldA==",GCMSenderID:"345127537656",stamp:E({appId:r,brand:"kia",mode:e,region:j.EU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t}),brandAuthUrl:({language:e,serviceId:t,userId:i})=>`https://eu-account.kia.com/auth/realms/eukiaidm/protocol/openid-connect/auth?client_id=572e0304-5f8d-4b4c-9dd5-41aa84eed160&scope=openid%20profile%20email%20phone&response_type=code&hkid_session_reset=true&redirect_uri=${o}/api/v1/user/integration/redirect/login&ui_locales=${e}&state=${t}:${i}`}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}},V=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&state=test&client_id=${t}&redirect_uri=${e}:443/api/v1/user/oauth2/redirect`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}:443/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),x=({brand:e})=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="prd.cn-ccapi.hyundai.com",t=`https://${e}`,i="72b3d019-5bc7-443d-a437-08f307cf06e2";return{brand:"hyundai",host:e,baseUrl:t,clientId:i,appId:"ed01581a-380f-48cd-83d4-ed1490c272d0",endpoints:Object.freeze(V(t,i)),basicToken:"Basic NzJiM2QwMTktNWJjNy00NDNkLWE0MzctMDhmMzA3Y2YwNmUyOnNlY3JldA==",GCMSenderID:"414998006775",providerDeviceId:"59af09e554a9442ab8589c9500d04d2e",pushRegId:"1"}})());case"kia":return Object.freeze((()=>{const e="prd.cn-ccapi.kia.com",t=`https://${e}`,i="9d5df92a-06ae-435f-b459-8304f2efcc67";return{brand:"kia",host:e,baseUrl:t,clientId:i,appId:"eea8762c-adfc-4ee4-8d7a-6e2452ddf342",endpoints:Object.freeze(V(t,i)),basicToken:"Basic OWQ1ZGY5MmEtMDZhZS00MzVmLWI0NTktODMwNGYyZWZjYzY3OnRzWGRrVWcwOEF2MlpaelhPZ1d6Snl4VVQ2eWVTbk5OUWtYWFBSZEtXRUFOd2wxcA==",GCMSenderID:"345127537656",providerDeviceId:"32dedba78045415b92db816e805ed47b",pushRegId:"ogc+GB5gom7zDEQjPhb3lP+bjjM=DG2rQ9Zuq0otwOU7n9y08LKjYpo="}})());default:throw new Error(`Constructor ${e} is not managed.`)}},H=(e,t)=>({session:`${e}/api/v1/user/oauth2/authorize?response_type=code&client_id=${t}&redirect_uri=${encodeURIComponent(`${e}/api/v1/user/oauth2/redirect`)}&lang=en`,login:`${e}/api/v1/user/signin`,language:`${e}/api/v1/user/language`,redirectUri:`${e}/api/v1/user/oauth2/redirect`,token:`${e}/api/v1/user/oauth2/token`,integration:`${e}/api/v1/user/integrationinfo`,silentSignIn:`${e}/api/v1/user/silentsignin`}),U=({brand:e,stampMode:t=O.LOCAL,stampsFile:i})=>{switch(e){case"hyundai":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.hyundai.com.au:8080",o=`https://${i}`,n="855c72df-dfd7-4230-ab03-67cbf902bb1c",r="f9ccfdac-a48d-4c57-bd32-9116963c24ed";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(H(o,n)),basicToken:"Basic ODU1YzcyZGYtZGZkNy00MjMwLWFiMDMtNjdjYmY5MDJiYjFjOmU2ZmJ3SE0zMllOYmhRbDBwdmlhUHAzcmY0dDNTNms5MWVjZUEzTUpMZGJkVGhDTw==",stamp:E({appId:r,brand:"hyundai",mode:e,region:j.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));case"kia":return Object.freeze((({stampMode:e,stampsFile:t})=>{const i="au-apigw.ccs.kia.com.au:8082",o=`https://${i}`,n="8acb778a-b918-4a8d-8624-73a0beb64289",r="4ad4dcde-be23-48a8-bc1c-91b94f5c06f8";return{brand:"hyundai",host:i,baseUrl:o,clientId:n,appId:r,endpoints:Object.freeze(H(o,n)),basicToken:"Basic OGFjYjc3OGEtYjkxOC00YThkLTg2MjQtNzNhMGJlYjY0Mjg5OjdTY01NbTZmRVlYZGlFUEN4YVBhUW1nZVlkbFVyZndvaDRBZlhHT3pZSVMyQ3U5VA==",stamp:E({appId:r,brand:"kia",mode:e,region:j.AU,stampHost:"https://raw.githubusercontent.com/neoPix/bluelinky-stamps/master/",stampsFile:t})}})({stampMode:t,stampsFile:i}));default:throw new Error(`Constructor ${e} is not managed.`)}};var j;!function(e){e.US="US",e.CA="CA",e.EU="EU",e.CN="CN",e.AU="AU"}(j||(j={}));const _=[50,60,70,80,90,100],N={refresh:!1,parsed:!1};class F{constructor(e,t){this.vehicleConfig=e,this.controller=t,this._fullStatus=null,this._status=null,this._location=null,this._odometer=null,this.userConfig={username:void 0,password:void 0,region:j.EU,brand:"hyundai",autoLogin:!0,pin:void 0,vin:void 0,vehicleId:void 0},this.userConfig=t.userConfig}vin(){return this.vehicleConfig.vin}name(){return this.vehicleConfig.name}nickname(){return this.vehicleConfig.nickname}id(){return this.vehicleConfig.id}brandIndicator(){return this.vehicleConfig.brandIndicator}}class z extends F{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=j.US,b.debug(`US Vehicle ${this.vehicleConfig.regId} created`)}getDefaultHeaders(){return{access_token:this.controller.session.accessToken,client_id:this.controller.environment.clientId,Host:this.controller.environment.host,"User-Agent":"okhttp/3.12.0",registrationId:this.vehicleConfig.regId,gen:this.vehicleConfig.generation,username:this.userConfig.username,vin:this.vehicleConfig.vin,"APPCLOUD-VIN":this.vehicleConfig.vin,Language:"0",to:"ISS",encryptFlag:"false",from:"SPA",brandIndicator:this.vehicleConfig.brandIndicator,bluelinkservicepin:this.userConfig.pin,offset:"-5"}}fullStatus(){throw new Error("Method not implemented.")}odometer(){return c(this,void 0,void 0,(function*(){const e=yield this._request(`/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get odometer reading!";const t=JSON.parse(e.body).enrolledVehicleDetails.find((e=>e.vehicleDetails.vin===this.vin()));return this._odometer={value:t.vehicleDetails.odometer,unit:0},this._odometer}))}location(){return c(this,void 0,void 0,(function*(){const e=yield this._request("/ac/v2/rcs/rfc/findMyCar",{method:"GET",headers:Object.assign({},this.getDefaultHeaders())});if(200!==e.statusCode)throw"Failed to get location!";const t=JSON.parse(e.body);return{latitude:t.coord.lat,longitude:t.coord.lon,altitude:t.coord.alt,speed:{unit:t.speed.unit,value:t.speed.value},heading:t.head}}))}start(e){return c(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},{hvac:!1,duration:10,temperature:70,defrost:!1,heatedFeatures:!1,unit:"F"}),e),i={Ims:0,airCtrl:+t.hvac,airTemp:{unit:1,value:`${t.temperature}`},defrost:t.defrost,heating1:+t.heatedFeatures,igniOnDuration:t.duration,seatHeaterVentInfo:null,username:this.userConfig.username,vin:this.vehicleConfig.vin};return 200===(yield this._request("/ac/v2/rcs/rsc/start",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"}),body:i,json:!0})).statusCode?"Vehicle started!":"Failed to start vehicle"}))}stop(){return c(this,void 0,void 0,(function*(){if(200===(yield this._request("/ac/v2/rcs/rsc/stop",{method:"POST",headers:Object.assign(Object.assign({},this.getDefaultHeaders()),{offset:"-4"})})).statusCode)return"Vehicle stopped";throw"Failed to stop vehicle!"}))}status(e){var t,i,o,n,r,s,a,d,l,h,u,v,p,g,f,m,y,b,C;return c(this,void 0,void 0,(function*(){const c=Object.assign(Object.assign({},N),e),w=yield this._request("/ac/v2/rcs/rvs/vehicleStatus",{method:"GET",headers:Object.assign({REFRESH:c.refresh.toString()},this.getDefaultHeaders())}),{vehicleStatus:k}=JSON.parse(w.body),T={chassis:{hoodOpen:null==k?void 0:k.hoodOpen,trunkOpen:null==k?void 0:k.trunkOpen,locked:null==k?void 0:k.doorLock,openDoors:{frontRight:!!(null===(t=null==k?void 0:k.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==k?void 0:k.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==k?void 0:k.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==k?void 0:k.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==k?void 0:k.tirePressureLamp)||void 0===r?void 0:r.tirePressureWarningLampRearLeft),frontLeft:!!(null===(s=null==k?void 0:k.tirePressureLamp)||void 0===s?void 0:s.tirePressureWarningLampFrontLeft),frontRight:!!(null===(a=null==k?void 0:k.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampFrontRight),rearRight:!!(null===(d=null==k?void 0:k.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampRearRight),all:!!(null===(l=null==k?void 0:k.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==k?void 0:k.airCtrlOn,steeringwheelHeat:!!(null==k?void 0:k.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==k?void 0:k.sideBackWindowHeat),defrost:null==k?void 0:k.defrost,temperatureSetpoint:null===(h=null==k?void 0:k.airTemp)||void 0===h?void 0:h.value,temperatureUnit:null===(u=null==k?void 0:k.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:null==k?void 0:k.engine,accessory:null==k?void 0:k.acc,range:(null===(f=null===(g=null===(p=null===(v=null==k?void 0:k.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.totalAvailableRange)||void 0===f?void 0:f.value)||(null===(m=null==k?void 0:k.dte)||void 0===m?void 0:m.value),charging:null===(y=null==k?void 0:k.evStatus)||void 0===y?void 0:y.batteryCharge,batteryCharge12v:null===(b=null==k?void 0:k.battery)||void 0===b?void 0:b.batSoc,batteryChargeHV:null===(C=null==k?void 0:k.evStatus)||void 0===C?void 0:C.batteryStatus},lastupdate:new Date(null==k?void 0:k.dateTime)};return this._status=c.parsed?T:k,this._status}))}unlock(){return c(this,void 0,void 0,(function*(){const e=new a;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/on",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Unlock successful":"Something went wrong!"}))}lock(){return c(this,void 0,void 0,(function*(){const e=new a;e.append("userName",this.userConfig.username||""),e.append("vin",this.vehicleConfig.vin);return 200===(yield this._request("/ac/v2/rcs/rdo/off",{method:"POST",headers:Object.assign({},this.getDefaultHeaders()),body:e.toString()})).statusCode?"Lock successful":"Something went wrong!"}))}startCharge(){return c(this,void 0,void 0,(function*(){if(200===(yield this._request(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return b.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}))}stopCharge(){return c(this,void 0,void 0,(function*(){if(200===(yield e(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{method:"POST"})).statusCode)return b.debug(`Send stop charge command to vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}))}_request(t,i){return c(this,void 0,void 0,(function*(){yield this.controller.refreshAccessToken(),i.headers.access_token=this.controller.session.accessToken;const o=yield e(`${this.controller.environment.baseUrl}/${t}`,Object.assign({throwHttpErrors:!1},i));return(null==o?void 0:o.body)&&b.debug(o.body),o}))}}class B{constructor(e){this.userConfig=e,this.session={accessToken:"",refreshToken:"",controlToken:"",deviceId:"",tokenExpiresAt:0}}}class W extends Error{constructor(e,t){super(e),this.source=t,this.name=W.ErrorName}}W.ErrorName="ManagedBluelinkyError";const Y=(e,o)=>{var n;return e instanceof t?new W(`${o?`@${o}: `:""}[${e.statusCode}] ${e.statusMessage} on [${e.method}] ${e.url} - ${JSON.stringify(e.body)}`,e):e instanceof i?new W(`${o?`@${o}: `:""} Parsing error on [${e.method}] ${e.url} - ${JSON.stringify(null===(n=e.response)||void 0===n?void 0:n.body)}`,e):(Error,e)},J=(e,t)=>c(void 0,void 0,void 0,(function*(){const i=[];for(let o=0;o<e.length;o++)i.push(yield t(e[o],o,e));return i})),G=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));class q extends B{constructor(e){super(e),this.vehicles=[],this._environment=(e=>{switch(e){case"hyundai":return Object.freeze((()=>{const e="api.telematics.hyundaiusa.com";return{brand:"hyundai",host:e,baseUrl:`https://${e}`,clientId:"m66129Bb-em93-SPAHYN-bZ91-am4540zp19920",clientSecret:"v558o935-6nne-423i-baa8"}})());case"kia":return Object.freeze((()=>{const e="api.owners.kia.com";return{brand:"kia",host:e,baseUrl:`https://${e}/apigw/v1/`,clientId:"MWAMOBILE",clientSecret:"98er-w34rf-ibf3-3f6h"}})());default:throw new Error(`Constructor ${e} is not managed.`)}})(e.brand),b.debug("US Controller created")}get environment(){return this._environment}refreshAccessToken(){return c(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;try{if(this.session.refreshToken&&t){b.debug("refreshing token");const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token/refresh`,{method:"POST",body:{refresh_token:this.session.refreshToken},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_secret:this.environment.clientSecret,client_id:this.environment.clientId},json:!0});return b.debug(t.body),this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),b.debug("Token refreshed"),"Token refreshed"}return b.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh"}catch(e){throw Y(e,"AmericanController.refreshAccessToken")}}))}login(){return c(this,void 0,void 0,(function*(){b.debug("Logging in to the API");try{const t=yield e(`${this.environment.baseUrl}/v2/ac/oauth/token`,{method:"POST",body:{username:this.userConfig.username,password:this.userConfig.password},headers:{"User-Agent":"PostmanRuntime/7.26.10",client_id:this.environment.clientId,client_secret:this.environment.clientSecret},json:!0});return b.debug(t.body),200!==t.statusCode?"login bad":(this.session.accessToken=t.body.access_token,this.session.refreshToken=t.body.refresh_token,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+parseInt(t.body.expires_in)),"login good")}catch(e){throw Y(e,"AmericanController.login")}}))}logout(){return c(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return c(this,void 0,void 0,(function*(){try{const t=yield e(`${this.environment.baseUrl}/ac/v2/enrollment/details/${this.userConfig.username}`,{method:"GET",headers:{access_token:this.session.accessToken,client_id:this.environment.clientId,Host:this.environment.host,"User-Agent":"okhttp/3.12.0",payloadGenerated:"20200226171938",includeNonConnectedVehicles:"Y"}}),i=JSON.parse(t.body);return void 0===i.enrolledVehicleDetails?(this.vehicles=[],this.vehicles):(this.vehicles=i.enrolledVehicleDetails.map((e=>{const t=e.vehicleDetails,i={nickname:t.nickName,name:t.nickName,vin:t.vin,regDate:t.enrollmentDate,brandIndicator:t.brandIndicator,regId:t.regid,generation:t.modelYear>2016?"2":"1"};return new z(i,this)})),this.vehicles)}catch(e){throw Y(e,"AmericanController.getVehicles")}}))}}var Z,K,Q;!function(e){e[e.UNPLUGED=0]="UNPLUGED",e[e.FAST=1]="FAST",e[e.PORTABLE=2]="PORTABLE",e[e.STATION=3]="STATION"}(Z||(Z={})),function(e){e[e.FAST=0]="FAST",e[e.SLOW=1]="SLOW"}(K||(K={})),function(e){e[e.CLOSED=0]="CLOSED",e[e.OPEN=1]="OPEN",e[e.VENTILATION=2]="VENTILATION"}(Q||(Q={}));const X=(e,t,i)=>{const o=[];for(let n=e;n<=t;n+=i)o.push(n);return o},ee={EU:{start:14,end:30,step:.5},CA:{start:16,end:32,step:.5},CN:{start:14,end:30,step:.5},AU:{start:17,end:27,step:.5}},te=(e,t)=>{const{start:i,end:o,step:n}=ee[e],r=X(i,o,n).indexOf(t);return`${("0x"+r.toString(16).substr(-4).toUpperCase()).split("x")[1].toUpperCase()}H`.padStart(3,"0")},ie=(e,t)=>{const{start:i,end:o,step:n}=ee[e];return X(i,o,n)[parseInt(t,16)]},oe=e=>{const t=parseInt(e.substring(0,4)),i=parseInt(e.substring(4,6));if(e.length<=6)return new Date(t,i-1);const o=parseInt(e.substring(6,8));if(e.length<=8)return new Date(t,i-1,o);const n=parseInt(e.substring(8,10)),r=parseInt(e.substring(10,12)),s=parseInt(e.substring(12,14));return new Date(t,i-1,o,n,r,s)},ne=(e,t)=>new Date(e.getTime()+6e4*t);var re,se;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(re||(re={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(se||(se={}));class ae extends F{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=j.EU,this.serverRates={max:-1,current:-1},b.debug(`EU Vehicle ${this.vehicleConfig.id} created`)}start(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:te(j.EU,e.temperature),unit:e.unit}}));return b.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw Y(e,"EuropeVehicle.start")}}))}stop(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/temperature`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return b.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw Y(e,"EuropeVehicle.stop")}}))}lock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw Y(e,"EuropeVehicle.lock")}}))}unlock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw Y(e,"EuropeVehicle.unlock")}}))}fullStatus(e){return c(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.vehicleStatusInfo;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.gpsDetail}return this._fullStatus=e,this._fullStatus}catch(e){throw Y(e,"EuropeVehicle.fullStatus")}}))}status(e){var t,i,o,n,r,s,a,d,l,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,$,O,D,I,L,E,M,P,R,V,x,H,U,_,F,z,B,W,J,G;return c(this,void 0,void 0,(function*(){const c=Object.assign(Object.assign({},N),e),q=yield this.controller.getVehicleHttpService();try{const e=c.refresh?"":"/latest",N=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)),Y=c.refresh?N.body.resMsg:N.body.resMsg.vehicleStatusInfo.vehicleStatus,K={chassis:{hoodOpen:null==Y?void 0:Y.hoodOpen,trunkOpen:null==Y?void 0:Y.trunkOpen,locked:Y.doorLock,openDoors:{frontRight:!!(null===(t=null==Y?void 0:Y.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==Y?void 0:Y.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==Y?void 0:Y.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==Y?void 0:Y.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==Y?void 0:Y.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==Y?void 0:Y.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==Y?void 0:Y.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==Y?void 0:Y.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==Y?void 0:Y.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==Y?void 0:Y.airCtrlOn,steeringwheelHeat:!!(null==Y?void 0:Y.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==Y?void 0:Y.sideBackWindowHeat),defrost:null==Y?void 0:Y.defrost,temperatureSetpoint:ie(j.EU,null===(h=null==Y?void 0:Y.airTemp)||void 0===h?void 0:h.value),temperatureUnit:null===(u=null==Y?void 0:Y.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:Y.engine,accessory:null==Y?void 0:Y.acc,rangeGas:null!==(m=null===(f=null===(g=null===(p=null===(v=null==Y?void 0:Y.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==Y?void 0:Y.dte)||void 0===y?void 0:y.value,range:null===(k=null===(w=null===(C=null===(b=null==Y?void 0:Y.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===C?void 0:C.rangeByFuel)||void 0===w?void 0:w.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===($=null===(A=null===(S=null===(T=null==Y?void 0:Y.evStatus)||void 0===T?void 0:T.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===A?void 0:A.evModeRange)||void 0===$?void 0:$.value,plugedTo:null!==(D=null===(O=null==Y?void 0:Y.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==D?D:Z.UNPLUGED,charging:null===(I=null==Y?void 0:Y.evStatus)||void 0===I?void 0:I.batteryCharge,estimatedCurrentChargeDuration:null===(M=null===(E=null===(L=null==Y?void 0:Y.evStatus)||void 0===L?void 0:L.remainTime2)||void 0===E?void 0:E.atc)||void 0===M?void 0:M.value,estimatedFastChargeDuration:null===(V=null===(R=null===(P=null==Y?void 0:Y.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===V?void 0:V.value,estimatedPortableChargeDuration:null===(U=null===(H=null===(x=null==Y?void 0:Y.evStatus)||void 0===x?void 0:x.remainTime2)||void 0===H?void 0:H.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(z=null===(F=null===(_=null==Y?void 0:Y.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===F?void 0:F.etc3)||void 0===z?void 0:z.value,batteryCharge12v:null===(B=null==Y?void 0:Y.battery)||void 0===B?void 0:B.batSoc,batteryChargeHV:null===(W=null==Y?void 0:Y.evStatus)||void 0===W?void 0:W.batteryStatus},lastupdate:(null==Y?void 0:Y.time)?oe(null==Y?void 0:Y.time):null};return K.engine.range||(K.engine.rangeEV||K.engine.rangeGas)&&(K.engine.range=(null!==(J=K.engine.rangeEV)&&void 0!==J?J:0)+(null!==(G=K.engine.rangeGas)&&void 0!==G?G:0)),this._status=c.parsed?K:Y,this._status}catch(e){throw Y(e,"EuropeVehicle.status")}}))}odometer(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.vehicleStatusInfo.odometer,this._odometer}catch(e){throw Y(e,"EuropeVehicle.odometer")}}))}location(){var e,t,i,o,n,r,s;return c(this,void 0,void 0,(function*(){const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw Y(e,"EuropeVehicle.location")}}))}startCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"EuropeVehicle.startCharge")}}))}stopCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"EuropeVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,h,u;return c(this,void 0,void 0,(function*(){const c=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield c.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:de(e)}})),p=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return p?{start:null===(i=p.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=p.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:p.breakdown,driving:p.driving?{distance:null===(n=p.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=p.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=p.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=p.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:p.vehicleStatus?{tpms:(null===(d=p.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=p.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(h=p.vehicleStatus)||void 0===h?void 0:h.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw Y(e,"EuropeVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:de(e),setTripDay:i?le(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?oe(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=oe(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ne(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw Y(e,"EuropeVehicle.history")}}))}driveHistory(e=re.DAY){var t,i;return c(this,void 0,void 0,(function*(){const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?oe(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw Y(e,"EuropeVehicle.history")}}))}getChargeTargets(){var e;return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),o=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return o&&Array.isArray(o)?o.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw Y(e,"EuropeVehicle.getChargeTargets")}}))}setChargeTargets(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!_.includes(e.fast)||!_.includes(e.slow))throw new W(`Charge target values are limited to ${_.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:K.FAST,targetSOClevel:e.fast},{plugType:K.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw Y(e,"EuropeVehicle.setChargeTargets")}}))}setNavigation(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw Y(e,"EuropeVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function de(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function le(e){return e.day?`${de(e)}${e.day.toString().padStart(2,"0")}`:de(e)}function ce(t,i="en",o){return c(this,void 0,void 0,(function*(){const n=null!=o?o:new d;return yield e(t.endpoints.session,{cookieJar:n}),yield e(t.endpoints.language,{method:"POST",body:`{"lang":"${i}"}`,cookieJar:n}),n}))}const he={"User-Agent":"Mozilla/5.0 (iPhone; CPU iPhone OS 11_1 like Mac OS X) AppleWebKit/604.3.5 (KHTML, like Gecko) Version/11.0 Mobile/15B92 Safari/604.1"},ue=e=>e.catch((e=>"HTTPError"===e.name&&302===e.statusCode?e.response:Promise.reject(e)));class ve{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanBrandAuthStrategy"}login(t,i){return c(this,void 0,void 0,(function*(){const o=yield ce(this.environment,this.language,null==i?void 0:i.cookieJar),{body:{userId:n,serviceId:r}}=yield e(this.environment.endpoints.integration,{cookieJar:o,json:!0,headers:he}),d=this.environment.brandAuthUrl({language:this.language,userId:n,serviceId:r}),l=s.parse(d,!0),{body:c}=yield e(d,{cookieJar:o,headers:he}),h=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(c),u=null==h?void 0:h[1].replace(/&amp;/g,"&");if(!u)throw new Error("@EuropeanBrandAuthStrategy.login: cannot found the auth url from the form.");const v=new a;v.append("username",t.username),v.append("password",t.password),v.append("credentialId",""),v.append("rememberMe","on");const{headers:{location:p},body:g}=yield ue(e.post(u,{cookieJar:o,body:v.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},he),followRedirect:!1}));if(!p){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(g);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication failed, cannot retrieve error message")}const f=yield e(p,{cookieJar:o,headers:he});let m=f.url,y=f.body;if(!m)throw new Error(`@EuropeanBrandAuthStrategy.login: after login redirection got stuck : ${y}`);if(m.includes("login-actions/required-action")){const t=/action="([a-z0-9:/\-.?_=&;]*)"/gi.exec(y),i=/name="code" value="(.*)"/gi.exec(y);if(!t)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions url.");if(!i)throw new Error("@EuropeanBrandAuthStrategy.login: Cannot find login-actions code.");const n=t[1].startsWith("/")?`${l.protocol}//${l.host}${t[1]}`:t[1],r=new a;r.append("code",i[1]),r.append("accept","");const{headers:{location:s},body:d}=yield ue(e.post(n,{cookieJar:o,body:r.toString(),headers:Object.assign({"Content-Type":"application/x-www-form-urlencoded"},he)}));if(!s){const e=/<span class="kc-feedback-text">(.+)<\/span>/gm.exec(d);if(e)throw new Error(`@EuropeanBrandAuthStrategy.login: Authentication action failed with message : ${e[1]}`);throw new Error("@EuropeanBrandAuthStrategy.login: Authentication action failed, cannot retrieve error message")}const c=yield e(s,{cookieJar:o,headers:he});m=c.url,y=c.body}const{body:b,statusCode:C}=yield e.post(this.environment.endpoints.silentSignIn,{cookieJar:o,body:{intUserId:""},json:!0,headers:Object.assign(Object.assign({},he),{"ccsp-service-id":this.environment.clientId})});if(!b.redirectUrl)throw new Error(`@EuropeanBrandAuthStrategy.login: silent sign In didn't work, could not retrieve auth code. status: ${C}, body: ${JSON.stringify(b)}`);const{code:w}=s.parse(b.redirectUrl,!0).query;if(!w)throw new Error(`@EuropeanBrandAuthStrategy.login: Cannot find the argument code in ${b.redirectUrl}.`);return{code:w,cookies:o}}))}}class pe{constructor(e,t){this.environment=e,this.language=t}get name(){return"EuropeanLegacyAuthStrategy"}login(t,i){return c(this,void 0,void 0,(function*(){const o=yield ce(this.environment,this.language,null==i?void 0:i.cookieJar),{body:n,statusCode:r}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!n.redirectUrl)throw new Error(`@EuropeanLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${r}, body: ${JSON.stringify(n)}`);const{code:a}=s.parse(n.redirectUrl,!0).query;if(!a)throw new Error("@EuropeanLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:a,cookies:o}}))}}class ge extends B{constructor(e){var t;if(super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:G(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.userConfig.language=null!==(t=e.language)&&void 0!==t?t:"en",!M.includes(this.userConfig.language))throw new Error(`The language code ${this.userConfig.language} is not managed. Only ${M.join(", ")} are.`);this.session.deviceId=G(),this._environment=R(e),this.authStrategies={main:new ve(this._environment,this.userConfig.language),fallback:new pe(this._environment,this.userConfig.language)},b.debug("EU Controller created")}get environment(){return this._environment}refreshAccessToken(){return c(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return b.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return b.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return b.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw Y(e,"EuropeController.refreshAccessToken")}return b.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return c(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw Y(e,"EuropeController.pin")}}))}login(){return c(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@EuropeController.login: username and password must be defined.");let t=null;try{b.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){b.error(`@EuropeController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),b.debug(`@EuropeController.login: Trying to sign in with ${this.authStrategies.fallback.name}`),t=yield this.authStrategies.fallback.login({password:this.userConfig.password,username:this.userConfig.username})}b.debug("@EuropeController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"APNS",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),b.debug("@EuropeController.login: Device registered");const n=new a;n.append("grant_type","authorization_code"),n.append("redirect_uri",this.environment.endpoints.redirectUri),n.append("code",t.code);const r=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:n.toString(),cookieJar:t.cookies});if(200!==r.statusCode)throw new Error(`@EuropeController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return b.debug("@EuropeController.login: Session defined properly"),"Login success"}catch(e){throw Y(e,"EuropeController.login")}}))}logout(){return c(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return c(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield J(t.body.resMsg.vehicles,(t=>c(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return b.debug(`@EuropeController.getVehicles: Added vehicle ${o.id}`),new ae(o,this)}))))}catch(e){throw Y(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){var e;return c(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return c(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return c(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}class fe extends F{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=j.CA,this.timeOffset=-(new Date).getTimezoneOffset()/60,this._info=null,b.debug(`CA Vehicle ${this.vehicleConfig.id} created`)}fullStatus(){throw new Error("Method not implemented.")}status(e){var t,i,o,n,r,s,a,d,l,h,u,v,p,g,f,m,y;return c(this,void 0,void 0,(function*(){const c=Object.assign(Object.assign({},N),e);b.debug("Begin status request, polling car",c.refresh);try{let e=null;if(c.useInfo)yield this.setInfo(c.refresh),this._info&&(e=this._info.status);else{const o=c.refresh?this.controller.environment.endpoints.remoteStatus:this.controller.environment.endpoints.status,n=yield this.request(o,{});if(e=null===(t=n.result)||void 0===t?void 0:t.status,null==n?void 0:n.error)throw null===(i=null==n?void 0:n.error)||void 0===i?void 0:i.errorDesc}b.debug(e);let C=null;return e&&(C={chassis:{hoodOpen:null==e?void 0:e.hoodOpen,trunkOpen:null==e?void 0:e.trunkOpen,locked:null==e?void 0:e.doorLock,openDoors:{frontRight:!!(null===(o=null==e?void 0:e.doorOpen)||void 0===o?void 0:o.frontRight),frontLeft:!!(null===(n=null==e?void 0:e.doorOpen)||void 0===n?void 0:n.frontLeft),backLeft:!!(null===(r=null==e?void 0:e.doorOpen)||void 0===r?void 0:r.backLeft),backRight:!!(null===(s=null==e?void 0:e.doorOpen)||void 0===s?void 0:s.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(a=null==e?void 0:e.tirePressureLamp)||void 0===a?void 0:a.tirePressureWarningLampRearLeft),frontLeft:!!(null===(d=null==e?void 0:e.tirePressureLamp)||void 0===d?void 0:d.tirePressureWarningLampFrontLeft),frontRight:!!(null===(l=null==e?void 0:e.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampFrontRight),rearRight:!!(null===(h=null==e?void 0:e.tirePressureLamp)||void 0===h?void 0:h.tirePressureWarningLampRearRight),all:!!(null===(u=null==e?void 0:e.tirePressureLamp)||void 0===u?void 0:u.tirePressureWarningLampAll)}},climate:{active:null==e?void 0:e.airCtrlOn,steeringwheelHeat:!!(null==e?void 0:e.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==e?void 0:e.sideBackWindowHeat),defrost:null==e?void 0:e.defrost,temperatureSetpoint:null===(v=null==e?void 0:e.airTemp)||void 0===v?void 0:v.value,temperatureUnit:null===(p=null==e?void 0:e.airTemp)||void 0===p?void 0:p.unit},engine:{ignition:null==e?void 0:e.engine,accessory:null==e?void 0:e.acc,range:null===(g=null==e?void 0:e.dte)||void 0===g?void 0:g.value,charging:null===(f=null==e?void 0:e.evStatus)||void 0===f?void 0:f.batteryCharge,batteryCharge12v:null===(m=null==e?void 0:e.battery)||void 0===m?void 0:m.batSoc,batteryChargeHV:null===(y=null==e?void 0:e.evStatus)||void 0===y?void 0:y.batteryStatus},lastupdate:oe(null==e?void 0:e.lastStatusDate)}),this._status=c.parsed?C:e,this._status}catch(e){throw e.message}}))}lock(){return c(this,void 0,void 0,(function*(){b.debug("Begin lock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.lock,{},{pAuth:e}),"Lock successful"}catch(e){throw e.message}}))}unlock(){return c(this,void 0,void 0,(function*(){b.debug("Begin unlock request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.unlock,{},{pAuth:e}),"Unlock successful"}catch(e){throw e.message}}))}start(e){var t,i,o,n,r;return c(this,void 0,void 0,(function*(){b.debug("Begin startClimate request");try{const s={hvacInfo:{airCtrl:null!==(t=e.hvac)&&void 0!==t&&t||null!==(i=e.defrost)&&void 0!==i&&i?1:0,defrost:null!==(o=e.defrost)&&void 0!==o&&o,heating1:e.heatedFeatures?1:0}},a=e.temperature;if(null!=a)s.hvacInfo.airTemp={value:te(j.CA,a),unit:0,hvacTempType:1};else if(null!==(n=e.hvac)&&void 0!==n&&n||null!==(r=e.defrost)&&void 0!==r&&r)throw"air temperature should be specified";const d=yield this.getPreAuth(),l=yield this.request(this.controller.environment.endpoints.start,s,{pAuth:d});return b.debug(l),l.responseHeader&&0===l.responseHeader.responseCode?"Vehicle started!":"Failed to start vehicle"}catch(e){throw e.message}}))}stop(){return c(this,void 0,void 0,(function*(){b.debug("Begin stop request");try{const e=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.stop,{pAuth:e})}catch(e){throw"error: "+e}}))}lights(e=!1){return c(this,void 0,void 0,(function*(){b.debug("Begin lights request with horn "+e);try{const t=yield this.getPreAuth();return yield this.request(this.controller.environment.endpoints.hornlight,{horn:e},{pAuth:t})}catch(e){throw"error: "+e}}))}stopCharge(){return c(this,void 0,void 0,(function*(){b.debug("Begin stopCharge");const{stopCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}startCharge(){return c(this,void 0,void 0,(function*(){b.debug("Begin startCharge");const{startCharge:e}=this.controller.environment.endpoints;try{const t=yield this.getPreAuth();return yield this.request(e,{pin:this.controller.userConfig.pin,pAuth:t})}catch(e){throw"error: "+e}}))}setChargeTargets(e){return c(this,void 0,void 0,(function*(){if(b.debug("Begin setChargeTarget"),!_.includes(e.fast)||!_.includes(e.slow))throw new W(`Charge target values are limited to ${_.join(", ")}`);const{setChargeTarget:t}=this.controller.environment.endpoints;try{const i=yield this.getPreAuth();return yield this.request(t,{pin:this.controller.userConfig.pin,pAuth:i,tsoc:[{plugType:K.FAST,level:e.fast},{plugType:K.SLOW,level:e.slow}]})}catch(e){throw"error: "+e}}))}odometer(){return c(this,void 0,void 0,(function*(){try{if(yield this.setInfo(),this._info)return{unit:this._info.vehicle.odometer,value:this._info.vehicle.odometerUnit};throw"error: no info"}catch(e){throw"error: "+e}}))}location(){return c(this,void 0,void 0,(function*(){b.debug("Begin locate request");try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.locate,{},{pAuth:e});return this._location=t.result,this._location}catch(e){throw"error: "+e}}))}getPreAuth(){return c(this,void 0,void 0,(function*(){b.info("Begin pre-authentication");try{return(yield this.request(this.controller.environment.endpoints.verifyPin,{})).result.pAuth}catch(e){throw"error: "+e}}))}request(t,i,o={}){return c(this,void 0,void 0,(function*(){b.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`),yield this.controller.refreshAccessToken();const n={method:"POST",json:!0,throwHttpErrors:!1,headers:Object.assign({from:this.controller.environment.origin,language:1,offset:this.timeOffset,accessToken:this.controller.session.accessToken,vehicleId:this.vehicleConfig.id},o),body:Object.assign({pin:this.userConfig.pin},i)};try{const i=yield e(t,n);return 0!=i.body.responseHeader.responseCode?i.body.responseHeader.responseDesc:i.body}catch(e){throw"error: "+e}}))}setInfo(e=!1){return c(this,void 0,void 0,(function*(){if(null===this._info||e)try{const e=yield this.getPreAuth(),t=yield this.request(this.controller.environment.endpoints.vehicleInfo,{},{pAuth:e});this._info=t.result}catch(e){throw"error: "+e}}))}}class me extends B{constructor(e){super(e),this.vehicles=[],this.timeOffset=-(new Date).getTimezoneOffset()/60,b.debug("CA Controller created"),this._environment=k(e.brand)}get environment(){return this._environment}refreshAccessToken(){return c(this,void 0,void 0,(function*(){const e=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;return b.debug("shouldRefreshToken: "+e.toString()),this.session.refreshToken&&e?(yield this.login(),b.debug("Token refreshed"),"Token refreshed"):(b.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh")}))}login(){return c(this,void 0,void 0,(function*(){b.info("Begin login request");try{const e=yield this.request(this.environment.endpoints.login,{loginId:this.userConfig.username,password:this.userConfig.password});return b.debug(e.result),this.session.accessToken=e.result.accessToken,this.session.refreshToken=e.result.refreshToken,this.session.tokenExpiresAt=Math.floor(+new Date/1e3+e.result.expireIn),"login good"}catch(e){return"error: "+e}}))}logout(){return c(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return c(this,void 0,void 0,(function*(){b.info("Begin getVehicleList request");try{const e=(yield this.request(this.environment.endpoints.vehicleList,{})).result;return void 0===e.vehicles?(this.vehicles=[],this.vehicles):(e.vehicles.forEach((e=>{const t={nickname:e.nickName,name:e.nickName,vin:e.vin,regDate:e.enrollmentDate,brandIndicator:e.brandIndicator,regId:e.regid,id:e.vehicleId,generation:e.genType};this.vehicles.push(new fe(t,this))})),this.vehicles)}catch(e){return b.debug(e),this.vehicles}}))}request(t,i,o={}){return c(this,void 0,void 0,(function*(){b.debug(`[${t}] ${JSON.stringify(o)} ${JSON.stringify(i)}`);try{const n=yield e(t,{method:"POST",json:!0,headers:Object.assign({from:this.environment.origin,language:1,offset:this.timeOffset,accessToken:this.session.accessToken},o),body:Object.assign({},i)});if(0!=n.body.responseHeader.responseCode)throw n.body.responseHeader.responseDesc;return n.body}catch(e){throw Y(e,"CanadianController")}}))}}var ye,be;!function(e){e[e.DAY=0]="DAY",e[e.MONTH=1]="MONTH",e[e.ALL=2]="ALL"}(ye||(ye={})),function(e){e[e.TOTAL=0]="TOTAL",e[e.AVERAGE=1]="AVERAGE",e[e.TODAY=2]="TODAY"}(be||(be={}));class Ce extends F{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=j.CN,this.serverRates={max:-1,current:-1},b.debug(`CN Vehicle ${this.vehicleConfig.id} created`)}start(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:1,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:te(j.CN,e.temperature),unit:e.unit}}));return b.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw Y(e,"ChinaVehicle.start")}}))}stop(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return b.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw Y(e,"ChinaVehicle.stop")}}))}lock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw Y(e,"ChinaVehicle.lock")}}))}unlock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw Y(e,"ChinaVehicle.unlock")}}))}fullStatus(e){return c(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`)).body.resMsg.status;if(t.refresh){const t=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`));e.vehicleStatus=t.body.resMsg.status;const o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`));e.vehicleLocation=o.body.resMsg.coord}return this._fullStatus=e,this._fullStatus}catch(e){throw Y(e,"ChinaVehicle.fullStatus")}}))}status(e){var t,i,o,n,r,s,a,d,l,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,$,O,D,I,L,E,M,P,R,V,x,H,U,_,F,z,B,W,J,G;return c(this,void 0,void 0,(function*(){const c=Object.assign(Object.assign({},N),e),q=yield this.controller.getVehicleHttpService();try{const e=c.refresh?"":"/latest",N=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg.status,Y={chassis:{hoodOpen:null==N?void 0:N.hoodOpen,trunkOpen:null==N?void 0:N.trunkOpen,locked:N.doorLock,openDoors:{frontRight:!!(null===(t=null==N?void 0:N.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==N?void 0:N.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==N?void 0:N.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==N?void 0:N.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==N?void 0:N.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==N?void 0:N.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==N?void 0:N.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==N?void 0:N.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==N?void 0:N.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==N?void 0:N.airCtrlOn,steeringwheelHeat:!!(null==N?void 0:N.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==N?void 0:N.sideBackWindowHeat),defrost:null==N?void 0:N.defrost,temperatureSetpoint:ie(j.EU,null===(h=null==N?void 0:N.airTemp)||void 0===h?void 0:h.value),temperatureUnit:null===(u=null==N?void 0:N.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:N.engine,accessory:null==N?void 0:N.acc,rangeGas:null!==(m=null===(f=null===(g=null===(p=null===(v=null==N?void 0:N.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==N?void 0:N.dte)||void 0===y?void 0:y.value,range:null===(k=null===(w=null===(C=null===(b=null==N?void 0:N.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===C?void 0:C.rangeByFuel)||void 0===w?void 0:w.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===($=null===(A=null===(S=null===(T=null==N?void 0:N.evStatus)||void 0===T?void 0:T.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===A?void 0:A.evModeRange)||void 0===$?void 0:$.value,plugedTo:null!==(D=null===(O=null==N?void 0:N.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==D?D:Z.UNPLUGED,charging:null===(I=null==N?void 0:N.evStatus)||void 0===I?void 0:I.batteryCharge,estimatedCurrentChargeDuration:null===(M=null===(E=null===(L=null==N?void 0:N.evStatus)||void 0===L?void 0:L.remainTime2)||void 0===E?void 0:E.atc)||void 0===M?void 0:M.value,estimatedFastChargeDuration:null===(V=null===(R=null===(P=null==N?void 0:N.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===V?void 0:V.value,estimatedPortableChargeDuration:null===(U=null===(H=null===(x=null==N?void 0:N.evStatus)||void 0===x?void 0:x.remainTime2)||void 0===H?void 0:H.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(z=null===(F=null===(_=null==N?void 0:N.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===F?void 0:F.etc3)||void 0===z?void 0:z.value,batteryCharge12v:null===(B=null==N?void 0:N.battery)||void 0===B?void 0:B.batSoc,batteryChargeHV:null===(W=null==N?void 0:N.evStatus)||void 0===W?void 0:W.batteryStatus},lastupdate:(null==N?void 0:N.time)?oe(null==N?void 0:N.time):null};return Y.engine.range||(Y.engine.rangeEV||Y.engine.rangeGas)&&(Y.engine.range=(null!==(J=Y.engine.rangeEV)&&void 0!==J?J:0)+(null!==(G=Y.engine.rangeGas)&&void 0!==G?G:0)),this._status=c.parsed?Y:N,this._status}catch(e){throw Y(e,"ChinaVehicle.status")}}))}odometer(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`));return this._odometer=t.body.resMsg.status.odometer,this._odometer}catch(e){throw Y(e,"ChinaVehicle.odometer")}}))}location(){var e,t,i,o,n,r,s;return c(this,void 0,void 0,(function*(){const a=yield this.controller.getVehicleHttpService();try{const d=this.updateRates(yield a.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location`)),l=null!==(t=null===(e=d.body.resMsg)||void 0===e?void 0:e.gpsDetail)&&void 0!==t?t:d.body.resMsg;return this._location={latitude:null===(i=null==l?void 0:l.coord)||void 0===i?void 0:i.lat,longitude:null===(o=null==l?void 0:l.coord)||void 0===o?void 0:o.lon,altitude:null===(n=null==l?void 0:l.coord)||void 0===n?void 0:n.alt,speed:{unit:null===(r=null==l?void 0:l.speed)||void 0===r?void 0:r.unit,value:null===(s=null==l?void 0:l.speed)||void 0===s?void 0:s.value},heading:null==l?void 0:l.head},this._location}catch(e){throw Y(e,"ChinaVehicle.location")}}))}startCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"ChinaVehicle.startCharge")}}))}stopCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"ChinaVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,h,u;return c(this,void 0,void 0,(function*(){const c=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield c.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:we(e)}})),p=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return p?{start:null===(i=p.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=p.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:p.breakdown,driving:p.driving?{distance:null===(n=p.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=p.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=p.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=p.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:p.vehicleStatus?{tpms:(null===(d=p.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=p.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(h=p.vehicleStatus)||void 0===h?void 0:h.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw Y(e,"ChinaVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:we(e),setTripDay:i?ke(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?oe(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=oe(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ne(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw Y(e,"ChinaVehicle.history")}}))}driveHistory(e=ye.DAY){var t,i;return c(this,void 0,void 0,(function*(){const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?oe(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw Y(e,"ChinaVehicle.history")}}))}getChargeTargets(){var e;return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),o=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return o&&Array.isArray(o)?o.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw Y(e,"ChinaVehicle.getChargeTargets")}}))}setChargeTargets(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!_.includes(e.fast)||!_.includes(e.slow))throw new W(`Charge target values are limited to ${_.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:K.FAST,targetSOClevel:e.fast},{plugType:K.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw Y(e,"ChinaVehicle.setChargeTargets")}}))}setNavigation(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw Y(e,"ChinaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function we(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function ke(e){return e.day?`${we(e)}${e.day.toString().padStart(2,"0")}`:we(e)}class Te{constructor(e){this.environment=e}get name(){return"ChineseLegacyAuthStrategy"}login(t,i){return c(this,void 0,void 0,(function*(){const o=yield function(t,i){return c(this,void 0,void 0,(function*(){const o=null!=i?i:new d;return yield e(t.endpoints.session,{cookieJar:o}),yield e(t.endpoints.language,{method:"POST",body:'{"lang":"zh"}',cookieJar:o}),o}))}(this.environment,null==i?void 0:i.cookieJar),{body:n,statusCode:r}=yield e(this.environment.endpoints.login,{method:"POST",json:!0,body:{email:t.username,password:t.password},cookieJar:o});if(!n.redirectUrl)throw new Error(`@ChineseLegacyAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${r}, body: ${JSON.stringify(n)}`);const{code:a}=s.parse(n.redirectUrl,!0).query;if(!a)throw new Error("@ChineseLegacyAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:a,cookies:o}}))}}class Se extends B{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:G(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=G(),this._environment=x(e),this.authStrategies={main:new Te(this._environment)},b.debug("CN Controller created")}get environment(){return this._environment}refreshAccessToken(){return c(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return b.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return b.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return b.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw Y(e,"ChinaController.refreshAccessToken")}return b.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return c(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin?token=`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,b.debug(`controlToken is : ${this.session.controlToken}`),this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw Y(e,"ChinaController.pin")}}))}login(){return c(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@ChinaController.login: username and password must be defined.");let t=null;try{b.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){b.error(`@ChinaController.login: sign in with ${this.authStrategies.main.name} failed with error ${e.toString()}`),b.debug(`@ChinaController.login: Trying to sign in with ${this.authStrategies.main.name}`),t=yield this.authStrategies.main.login({password:this.userConfig.password,username:this.userConfig.username})}b.debug("@ChinaController.login: Authenticated properly with user and password");const i=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId},body:{pushRegId:this.environment.pushRegId,providerDeviceId:this.environment.providerDeviceId,pushType:"GCM",uuid:G()},json:!0});i&&(this.session.deviceId=i.body.resMsg.deviceId),b.debug("@ChinaController.login: Device registered");const o=new a;o.append("grant_type","authorization_code"),o.append("redirect_uri",this.environment.endpoints.redirectUri),o.append("code",t.code);const n=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code"},body:o.toString(),cookieJar:t.cookies});if(200!==n.statusCode)throw new Error(`@ChinaController.login: Could not manage to get token: ${n.body}`);if(n){const e=JSON.parse(n.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return b.debug("@ChinaController.login: Session defined properly"),b.debug(`accessToken is ${this.session.accessToken}\n refreshToken is ${this.session.refreshToken}\n tokenExpiresAt : ${this.session.tokenExpiresAt}`),"Login success"}catch(e){throw Y(e,"ChinaController.login")}}))}logout(){return c(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return c(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0});this.vehicles=yield J(t.body.resMsg.vehicles,(t=>c(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign({},this.defaultHeaders),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return b.debug(`@ChineseController.getVehicles: Added vehicle ${o.id}`),new Ce(o,this)}))))}catch(e){throw Y(e,"EuropeController.getVehicles")}return this.vehicles}))}checkControlToken(){var e;return c(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return c(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,AuthorizationCCSP:this.session.controlToken,"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c"}),json:!0})}))}getApiHttpService(){return c(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign({},this.defaultHeaders),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(0),"ccsp-device-id":"2e062595-28e0-4bcb-a75a-1b395cde337c","ccsp-application-id":this.environment.appId,"Content-Type":"application/json","User-Agent":"okhttp/4.4.0"}}}class Ae extends F{constructor(e,t){super(e,t),this.vehicleConfig=e,this.controller=t,this.region=j.AU,this.serverRates={max:-1,current:-1},b.debug(`AU Vehicle ${this.vehicleConfig.id} created`)}start(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"start",hvacType:0,options:{defrost:e.defrost,heating1:e.heatedFeatures?1:0},tempCode:te(j.AU,e.temperature),unit:e.unit}}));return b.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw Y(e,"AustraliaVehicle.start")}}))}stop(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/engine`,{body:{action:"stop",hvacType:0,options:{defrost:!0,heating1:1},tempCode:"10H",unit:"C"}}));return b.info(`Climate stopped for vehicle ${this.vehicleConfig.id}`),t.body}catch(e){throw Y(e,"AustraliaVehicle.stop")}}))}lock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"close",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} locked`),"Lock successful"):"Something went wrong!"}catch(e){throw Y(e,"AustraliaVehicle.lock")}}))}unlock(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{return 200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/door`,{body:{action:"open",deviceId:this.controller.session.deviceId}})).statusCode?(b.debug(`Vehicle ${this.vehicleConfig.id} unlocked`),"Unlock successful"):"Something went wrong!"}catch(e){throw Y(e,"AustraliaVehicle.unlock")}}))}setWindows(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/windowcurtain`,{body:e}));return b.info(`Climate started for vehicle ${this.vehicleConfig.id}`),i.body}catch(e){throw Y(e,"AustraliaVehicle.start")}}))}fullStatus(e){return c(this,void 0,void 0,(function*(){const t=Object.assign(Object.assign({},N),e),i=yield this.controller.getVehicleHttpService();try{const e=this.updateRates(t.refresh?yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status/latest`):yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status`)),o=this.updateRates(yield i.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)),n=yield this.odometer();return n?(this._fullStatus={vehicleLocation:o.body.resMsg.gpsDetail,odometer:n,vehicleStatus:e.body.resMsg},this._fullStatus):null}catch(e){throw Y(e,"AustraliaVehicle.fullStatus")}}))}status(e){var t,i,o,n,r,s,a,d,l,h,u,v,p,g,f,m,y,b,C,w,k,T,S,A,$,O,D,I,L,E,M,P,R,V,x,H,U,_,F,z,B,W,J,G;return c(this,void 0,void 0,(function*(){const c=Object.assign(Object.assign({},N),e),q=yield this.controller.getVehicleHttpService();try{const e=c.refresh?"":"/latest",N=this.updateRates(yield q.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/status${e}`)).body.resMsg,Y={chassis:{hoodOpen:null==N?void 0:N.hoodOpen,trunkOpen:null==N?void 0:N.trunkOpen,locked:N.doorLock,openDoors:{frontRight:!!(null===(t=null==N?void 0:N.doorOpen)||void 0===t?void 0:t.frontRight),frontLeft:!!(null===(i=null==N?void 0:N.doorOpen)||void 0===i?void 0:i.frontLeft),backLeft:!!(null===(o=null==N?void 0:N.doorOpen)||void 0===o?void 0:o.backLeft),backRight:!!(null===(n=null==N?void 0:N.doorOpen)||void 0===n?void 0:n.backRight)},tirePressureWarningLamp:{rearLeft:!!(null===(r=null==N?void 0:N.tirePressureLamp)||void 0===r?void 0:r.tirePressureLampRL),frontLeft:!!(null===(s=null==N?void 0:N.tirePressureLamp)||void 0===s?void 0:s.tirePressureLampFL),frontRight:!!(null===(a=null==N?void 0:N.tirePressureLamp)||void 0===a?void 0:a.tirePressureLampFR),rearRight:!!(null===(d=null==N?void 0:N.tirePressureLamp)||void 0===d?void 0:d.tirePressureLampRR),all:!!(null===(l=null==N?void 0:N.tirePressureLamp)||void 0===l?void 0:l.tirePressureWarningLampAll)}},climate:{active:null==N?void 0:N.airCtrlOn,steeringwheelHeat:!!(null==N?void 0:N.steerWheelHeat),sideMirrorHeat:!1,rearWindowHeat:!!(null==N?void 0:N.sideBackWindowHeat),defrost:null==N?void 0:N.defrost,temperatureSetpoint:ie(j.AU,null===(h=null==N?void 0:N.airTemp)||void 0===h?void 0:h.value),temperatureUnit:null===(u=null==N?void 0:N.airTemp)||void 0===u?void 0:u.unit},engine:{ignition:N.engine,accessory:null==N?void 0:N.acc,rangeGas:null!==(m=null===(f=null===(g=null===(p=null===(v=null==N?void 0:N.evStatus)||void 0===v?void 0:v.drvDistance[0])||void 0===p?void 0:p.rangeByFuel)||void 0===g?void 0:g.gasModeRange)||void 0===f?void 0:f.value)&&void 0!==m?m:null===(y=null==N?void 0:N.dte)||void 0===y?void 0:y.value,range:null===(k=null===(w=null===(C=null===(b=null==N?void 0:N.evStatus)||void 0===b?void 0:b.drvDistance[0])||void 0===C?void 0:C.rangeByFuel)||void 0===w?void 0:w.totalAvailableRange)||void 0===k?void 0:k.value,rangeEV:null===($=null===(A=null===(S=null===(T=null==N?void 0:N.evStatus)||void 0===T?void 0:T.drvDistance[0])||void 0===S?void 0:S.rangeByFuel)||void 0===A?void 0:A.evModeRange)||void 0===$?void 0:$.value,plugedTo:null!==(D=null===(O=null==N?void 0:N.evStatus)||void 0===O?void 0:O.batteryPlugin)&&void 0!==D?D:Z.UNPLUGED,charging:null===(I=null==N?void 0:N.evStatus)||void 0===I?void 0:I.batteryCharge,estimatedCurrentChargeDuration:null===(M=null===(E=null===(L=null==N?void 0:N.evStatus)||void 0===L?void 0:L.remainTime2)||void 0===E?void 0:E.atc)||void 0===M?void 0:M.value,estimatedFastChargeDuration:null===(V=null===(R=null===(P=null==N?void 0:N.evStatus)||void 0===P?void 0:P.remainTime2)||void 0===R?void 0:R.etc1)||void 0===V?void 0:V.value,estimatedPortableChargeDuration:null===(U=null===(H=null===(x=null==N?void 0:N.evStatus)||void 0===x?void 0:x.remainTime2)||void 0===H?void 0:H.etc2)||void 0===U?void 0:U.value,estimatedStationChargeDuration:null===(z=null===(F=null===(_=null==N?void 0:N.evStatus)||void 0===_?void 0:_.remainTime2)||void 0===F?void 0:F.etc3)||void 0===z?void 0:z.value,batteryCharge12v:null===(B=null==N?void 0:N.battery)||void 0===B?void 0:B.batSoc,batteryChargeHV:null===(W=null==N?void 0:N.evStatus)||void 0===W?void 0:W.batteryStatus},lastupdate:(null==N?void 0:N.time)?oe(null==N?void 0:N.time):null};return Y.engine.range||(Y.engine.rangeEV||Y.engine.rangeGas)&&(Y.engine.range=(null!==(J=Y.engine.rangeEV)&&void 0!==J?J:0)+(null!==(G=Y.engine.rangeGas)&&void 0!==G?G:0)),this._status=c.parsed?Y:N,this._status}catch(e){throw Y(e,"AustraliaVehicle.status")}}))}odometer(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{const t=this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:$e({year:(new Date).getFullYear(),month:(new Date).getMonth()+1})}}));return this._odometer={unit:0,value:t.body.resMsg.odometer},this._odometer}catch(e){throw Y(e,"AustraliaVehicle.odometer")}}))}location(){var e,t,i,o,n,r;return c(this,void 0,void 0,(function*(){const s=yield this.controller.getVehicleHttpService();try{const a=this.updateRates(yield s.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/park`)),d=null===(e=a.body.resMsg)||void 0===e?void 0:e.gpsDetail;return this._location={latitude:null===(t=null==d?void 0:d.coord)||void 0===t?void 0:t.lat,longitude:null===(i=null==d?void 0:d.coord)||void 0===i?void 0:i.lon,altitude:null===(o=null==d?void 0:d.coord)||void 0===o?void 0:o.alt,speed:{unit:null===(n=null==d?void 0:d.speed)||void 0===n?void 0:n.unit,value:null===(r=null==d?void 0:d.speed)||void 0===r?void 0:r.value},heading:null==d?void 0:d.head},this._location}catch(e){throw Y(e,"AustraliaVehicle.location")}}))}startCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"start",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send start charge command to Vehicle ${this.vehicleConfig.id}`),"Start charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"AustraliaVehicle.startCharge")}}))}stopCharge(){return c(this,void 0,void 0,(function*(){const e=yield this.controller.getVehicleHttpService();try{if(200===this.updateRates(yield e.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/control/charge`,{body:{action:"stop",deviceId:this.controller.session.deviceId}})).statusCode)return b.debug(`Send stop charge command to Vehicle ${this.vehicleConfig.id}`),"Stop charge successful";throw"Something went wrong!"}catch(e){throw Y(e,"AustraliaVehicle.stopCharge")}}))}monthlyReport(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){var t,i,o,n,r,s,a,d,l,h,u;return c(this,void 0,void 0,(function*(){const c=yield this.controller.getVehicleHttpService();try{const v=this.updateRates(yield c.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/monthlyreport`,{body:{setRptMonth:$e(e)}})),p=null===(t=v.body.resMsg)||void 0===t?void 0:t.monthlyReport;return p?{start:null===(i=p.ifo)||void 0===i?void 0:i.mvrMonthStart,end:null===(o=p.ifo)||void 0===o?void 0:o.mvrMonthEnd,breakdown:p.breakdown,driving:p.driving?{distance:null===(n=p.driving)||void 0===n?void 0:n.runDistance,startCount:null===(r=p.driving)||void 0===r?void 0:r.engineStartCount,durations:{idle:null===(s=p.driving)||void 0===s?void 0:s.engineIdleTime,drive:null===(a=p.driving)||void 0===a?void 0:a.engineOnTime}}:void 0,vehicleStatus:p.vehicleStatus?{tpms:(null===(d=p.vehicleStatus)||void 0===d?void 0:d.tpmsSupport)?Boolean(null===(l=p.vehicleStatus)||void 0===l?void 0:l.tpmsSupport):void 0,tirePressure:{all:"1"==(null===(u=null===(h=p.vehicleStatus)||void 0===h?void 0:h.tirePressure)||void 0===u?void 0:u.tirePressureLampAll)}}:void 0}:void 0}catch(e){throw Y(e,"AustraliaVehicle.monthyReports")}}))}tripInfo(e={year:(new Date).getFullYear(),month:(new Date).getMonth()+1}){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getApiHttpService();try{const i=Boolean(e.day),o=this.updateRates(yield t.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/tripinfo`,{body:{setTripLatest:10,setTripMonth:i?void 0:$e(e),setTripDay:i?Oe(e):void 0,tripPeriodType:i?1:0}}));if(!i){const e=o.body.resMsg;return{days:Array.isArray(null==e?void 0:e.tripDayList)?null==e?void 0:e.tripDayList.map((e=>({dayRaw:e.tripDayInMonth,date:e.tripDayInMonth?oe(e.tripDayInMonth):void 0,tripsCount:e.tripCntDay}))):[],durations:{drive:null==e?void 0:e.tripDrvTime,idle:null==e?void 0:e.tripIdleTime},distance:null==e?void 0:e.tripDist,speed:{avg:null==e?void 0:e.tripAvgSpeed,max:null==e?void 0:e.tripMaxSpeed}}}{const e=o.body.resMsg.dayTripList;if(e&&Array.isArray(e))return e.map((e=>({dayRaw:e.tripDay,tripsCount:e.dayTripCnt,distance:e.tripDist,durations:{drive:e.tripDrvTime,idle:e.tripIdleTime},speed:{avg:e.tripAvgSpeed,max:e.tripMaxSpeed},trips:Array.isArray(e.tripList)?e.tripList.map((t=>{const i=oe(`${e.tripDay}${t.tripTime}`);return{timeRaw:t.tripTime,start:i,end:ne(i,t.tripDrvTime),durations:{drive:t.tripDrvTime,idle:t.tripIdleTime},speed:{avg:t.tripAvgSpeed,max:t.tripMaxSpeed},distance:t.tripDist}})):[]})))}return}catch(e){throw Y(e,"AustraliaVehicle.history")}}))}driveHistory(e=re.DAY){var t,i;return c(this,void 0,void 0,(function*(){const o=yield this.controller.getApiHttpService();try{const n=yield o.post(`/api/v1/spa/vehicles/${this.vehicleConfig.id}/drvhistory`,{body:{periodTarget:e}});return{cumulated:null===(t=n.body.resMsg.drivingInfo)||void 0===t?void 0:t.map((e=>({period:e.drivingPeriod,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo}))),history:null===(i=n.body.resMsg.drivingInfoDetail)||void 0===i?void 0:i.map((e=>({period:e.drivingPeriod,rawDate:e.drivingDate,date:e.drivingDate?oe(e.drivingDate):void 0,consumption:{total:e.totalPwrCsp,engine:e.motorPwrCsp,climate:e.climatePwrCsp,devices:e.eDPwrCsp,battery:e.batteryMgPwrCsp},regen:e.regenPwr,distance:e.calculativeOdo})))}}catch(e){throw Y(e,"AustraliaVehicle.history")}}))}getChargeTargets(){var e;return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{const i=this.updateRates(yield t.get(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`)),o=null===(e=i.body.resMsg)||void 0===e?void 0:e.targetSOClist;return o&&Array.isArray(o)?o.map((e=>{var t,i;return{distance:null===(i=null===(t=e.drvDistance)||void 0===t?void 0:t.distanceType)||void 0===i?void 0:i.distanceValue,targetLevel:e.targetSOClevel,type:e.plugType}})):void 0}catch(e){throw Y(e,"AustraliaVehicle.getChargeTargets")}}))}setChargeTargets(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();if(!_.includes(e.fast)||!_.includes(e.slow))throw new W(`Charge target values are limited to ${_.join(", ")}`);try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/charge/target`,{body:{targetSOClist:[{plugType:K.FAST,targetSOClevel:e.fast},{plugType:K.SLOW,targetSOClevel:e.slow}]}}))}catch(e){throw Y(e,"AustraliaVehicle.setChargeTargets")}}))}setNavigation(e){return c(this,void 0,void 0,(function*(){const t=yield this.controller.getVehicleHttpService();try{this.updateRates(yield t.post(`/api/v2/spa/vehicles/${this.vehicleConfig.id}/location/routes`,{body:{deviceID:this.controller.session.deviceId,poiInfoList:e}}))}catch(e){throw Y(e,"AustraliaVehicle.setNavigation")}}))}updateRates(e){var t,i,o,n,r;return(null===(t=e.headers)||void 0===t?void 0:t["x-ratelimit-limit"])&&(this.serverRates.max=Number(null===(i=e.headers)||void 0===i?void 0:i["x-ratelimit-limit"]),this.serverRates.current=Number(null===(o=e.headers)||void 0===o?void 0:o["x-ratelimit-remaining"]),(null===(n=e.headers)||void 0===n?void 0:n["x-ratelimit-reset"])&&(this.serverRates.reset=new Date(Number(`${null===(r=e.headers)||void 0===r?void 0:r["x-ratelimit-reset"]}000`))),this.serverRates.updatedAt=new Date),e}}function $e(e){return`${e.year}${e.month.toString().padStart(2,"0")}`}function Oe(e){return e.day?`${$e(e)}${e.day.toString().padStart(2,"0")}`:$e(e)}class De{constructor(e){this.environment=e}get name(){return"AustraliaAuthStrategy"}login(t,i){var o;return c(this,void 0,void 0,(function*(){const n=null!==(o=null==i?void 0:i.cookieJar)&&void 0!==o?o:new d;yield e(this.environment.endpoints.session,{cookieJar:n});const{body:r,statusCode:a}=yield e(this.environment.endpoints.login,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({email:t.username,password:t.password,mobileNum:""}),cookieJar:n}),l=JSON.parse(r);if(!l.redirectUrl)throw new Error(`@AustraliaAuthStrategy.login: sign In didn't work, could not retrieve auth code. status: ${a}, body: ${JSON.stringify(l)}`);const{code:c}=s.parse(l.redirectUrl,!0).query;if(!c)throw new Error("@AustraliaAuthStrategy.login: AuthCode was not found, you probably need to migrate your account.");return{code:c,cookies:n}}))}}class Ie extends B{constructor(e){super(e),this.session={accessToken:void 0,refreshToken:void 0,controlToken:void 0,deviceId:G(),tokenExpiresAt:0,controlTokenExpiresAt:0},this.vehicles=[],this.session.deviceId=G(),this._environment=U(e),this.authStrategy=new De(this._environment),b.debug("AU Controller created")}get environment(){return this._environment}refreshAccessToken(){return c(this,void 0,void 0,(function*(){const t=Math.floor(Date.now()/1e3-this.session.tokenExpiresAt)>=-10;if(!this.session.refreshToken)return b.debug("Need refresh token to refresh access token. Use login()"),"Need refresh token to refresh access token. Use login()";if(!t)return b.debug("Token not expired, no need to refresh"),"Token not expired, no need to refresh";const i=new a;i.append("grant_type","refresh_token"),i.append("redirect_uri","https://www.getpostman.com/oauth2/callback"),i.append("refresh_token",this.session.refreshToken);try{const t=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0"},body:i.toString(),throwHttpErrors:!1});if(200!==t.statusCode)return b.debug(`Refresh token failed: ${t.body}`),`Refresh token failed: ${t.body}`;const o=JSON.parse(t.body);this.session.accessToken="Bearer "+o.access_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+o.expires_in)}catch(e){throw Y(e,"AustraliaController.refreshAccessToken")}return b.debug("Token refreshed"),"Token refreshed"}))}enterPin(){return c(this,void 0,void 0,(function*(){if(""===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/user/pin`,{method:"PUT",headers:{Authorization:this.session.accessToken,"Content-Type":"application/json"},body:{deviceId:this.session.deviceId,pin:this.userConfig.pin},json:!0});return this.session.controlToken="Bearer "+t.body.controlToken,this.session.controlTokenExpiresAt=Math.floor(Date.now()/1e3+t.body.expiresTime),"PIN entered OK, The pin is valid for 10 minutes"}catch(e){throw Y(e,"AustraliaController.pin")}}))}login(){return c(this,void 0,void 0,(function*(){try{if(!this.userConfig.password||!this.userConfig.username)throw new Error("@AustraliaController.login: username and password must be defined.");let t=null;try{b.debug(`@AustraliaController.login: Trying to sign in with ${this.authStrategy.name}`),t=yield this.authStrategy.login({password:this.userConfig.password,username:this.userConfig.username})}catch(e){throw new Error(`@AustraliaController.login: sign in with ${this.authStrategy.name} failed with error ${e.toString()}`)}b.debug("@AustraliaController.login: Authenticated properly with user and password");const i=e=>[...Array(e)].map((()=>Math.floor(16*Math.random()).toString(16))).join(""),o=yield e(`${this.environment.baseUrl}/api/v1/spa/notifications/register`,{method:"POST",headers:{"ccsp-service-id":this.environment.clientId,"Content-Type":"application/json;charset=UTF-8",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:{pushRegId:i(64),pushType:"GCM",uuid:this.session.deviceId},json:!0});o&&(this.session.deviceId=o.body.resMsg.deviceId),b.debug("@AustraliaController.login: Device registered");const n=new a;n.append("grant_type","authorization_code"),n.append("redirect_uri",this.environment.endpoints.redirectUri),n.append("code",t.code);const r=yield e(this.environment.endpoints.token,{method:"POST",headers:{Authorization:this.environment.basicToken,"Content-Type":"application/x-www-form-urlencoded",Host:this.environment.host,Connection:"Keep-Alive","Accept-Encoding":"gzip","User-Agent":"okhttp/3.10.0",grant_type:"authorization_code","ccsp-application-id":this.environment.appId,Stamp:yield this.environment.stamp()},body:n.toString(),cookieJar:t.cookies});if(200!==r.statusCode)throw new Error(`@AustraliaController.login: Could not manage to get token: ${r.body}`);if(r){const e=JSON.parse(r.body);this.session.accessToken=`Bearer ${e.access_token}`,this.session.refreshToken=e.refresh_token,this.session.tokenExpiresAt=Math.floor(Date.now()/1e3+e.expires_in)}return b.debug("@AustraliaController.login: Session defined properly"),"Login success"}catch(e){throw Y(e,"AustraliaController.login")}}))}logout(){return c(this,void 0,void 0,(function*(){return"OK"}))}getVehicles(){return c(this,void 0,void 0,(function*(){if(void 0===this.session.accessToken)throw"Token not set";try{const t=yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0});this.vehicles=yield J(t.body.resMsg.vehicles,(t=>c(this,void 0,void 0,(function*(){const i=(yield e(`${this.environment.baseUrl}/api/v1/spa/vehicles/${t.vehicleId}/profile`,{method:"GET",headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})).body.resMsg,o={nickname:t.nickname,name:t.vehicleName,regDate:t.regDate,brandIndicator:"H",id:t.vehicleId,vin:i.vinInfo[0].basic.vin,generation:i.vinInfo[0].basic.modelYear};return b.debug(`@AustraliaController.getVehicles: Added vehicle ${o.id}`),new Ae(o,this)}))))}catch(e){throw Y(e,"AustraliaController.getVehicles")}return this.vehicles}))}checkControlToken(){var e;return c(this,void 0,void 0,(function*(){yield this.refreshAccessToken(),void 0!==(null===(e=this.session)||void 0===e?void 0:e.controlTokenExpiresAt)&&(!this.session.controlToken||Date.now()/1e3>this.session.controlTokenExpiresAt)&&(yield this.enterPin())}))}getVehicleHttpService(){return c(this,void 0,void 0,(function*(){return yield this.checkControlToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Authorization:this.session.controlToken,Stamp:yield this.environment.stamp()}),json:!0})}))}getApiHttpService(){return c(this,void 0,void 0,(function*(){return yield this.refreshAccessToken(),e.extend({baseUrl:this.environment.baseUrl,headers:Object.assign(Object.assign({},this.defaultHeaders),{Stamp:yield this.environment.stamp()}),json:!0})}))}get defaultHeaders(){return{Authorization:this.session.accessToken,offset:((new Date).getTimezoneOffset()/60).toFixed(2),"ccsp-device-id":this.session.deviceId,"ccsp-application-id":this.environment.appId,"Content-Type":"application/json"}}}const Le={username:"",password:"",region:j.US,brand:"hyundai",autoLogin:!0,pin:"1234",vin:"",vehicleId:void 0};class Ee extends l{constructor(e){switch(super(),this.vehicles=[],this.config=Object.assign(Object.assign({},Le),e),e.region){case j.EU:this.controller=new ge(this.config);break;case j.US:this.controller=new q(this.config);break;case j.CA:this.controller=new me(this.config);break;case j.CN:this.controller=new Se(this.config);break;case j.AU:this.controller=new Ie(this.config);break;default:throw new Error("Your region is not supported yet.")}void 0===e.autoLogin&&(this.config.autoLogin=!0),this.onInit()}on(e,t){return super.on(e,t)}onInit(){this.config.autoLogin&&(b.debug("Bluelinky is logging in automatically, to disable use autoLogin: false"),this.login())}login(){return c(this,void 0,void 0,(function*(){try{const e=yield this.controller.login();return this.vehicles=yield this.getVehicles(),b.debug(`Found ${this.vehicles.length} on the account`),this.emit("ready",this.vehicles),e}catch(e){return this.emit("error",e),e.message}}))}getVehicles(){return c(this,void 0,void 0,(function*(){return(yield this.controller.getVehicles())||[]}))}getVehicle(e){try{const t=this.vehicles.find((t=>t.vin().toLowerCase()===e.toLowerCase()));if(!t&&this.vehicles.length>0)throw new Error(`Could not find vehicle with id: ${e}`);return t}catch(t){throw new Error(`Vehicle not found: ${e}!`)}}refreshAccessToken(){return c(this,void 0,void 0,(function*(){return this.controller.refreshAccessToken()}))}logout(){return c(this,void 0,void 0,(function*(){return this.controller.logout()}))}getSession(){return this.controller.session}get cachedVehicles(){var e;return null!==(e=this.vehicles)&&void 0!==e?e:[]}}export{Ee as BlueLinky,Ee as default};
